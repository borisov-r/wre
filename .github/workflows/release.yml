name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  CARGO_TERM_COLOR: always
  # Note: These are placeholder WiFi credentials for build requirements only
  # Users must configure WiFi settings on the device after flashing
  WIFI_SSID: "configure_your_ssid"
  WIFI_PASS: "configure_your_password"

jobs:
  build-and-release:
    name: Build and Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Get version from tag
      id: tag_name
      run: |
        echo "current_version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        
    - name: Install Rust
      uses: dtolnay/rust-toolchain@v1
      with:
        toolchain: stable
        components: rust-src
        
    - name: Install espup
      run: |
        # Temporarily move rust-toolchain.toml to avoid toolchain conflict
        mv rust-toolchain.toml rust-toolchain.toml.bak
        cargo install espup
        espup install
        # Restore rust-toolchain.toml
        mv rust-toolchain.toml.bak rust-toolchain.toml
        
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-
          
    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-index-
          
    - name: Cache target directory
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-target-
    
    - name: Build release
      run: |
        . $HOME/export-esp.sh
        cargo build --release
        
    - name: Verify build output
      run: |
        if [ ! -f target/xtensa-esp32-espidf/release/wre ]; then
          echo "Error: Build binary not found at expected location"
          exit 1
        fi
        ls -lh target/xtensa-esp32-espidf/release/wre
        
    - name: Prepare release artifacts
      run: |
        mkdir -p release-artifacts
        cp target/xtensa-esp32-espidf/release/wre release-artifacts/wre-esp32-${{ steps.tag_name.outputs.tag_name }}
        cp README.md release-artifacts/
        if [ -f LICENSE ]; then
          cp LICENSE release-artifacts/
        fi
        cp QUICKSTART.md release-artifacts/
        cp NODEMCU_SETUP.md release-artifacts/
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          release-artifacts/*
        body: |
          ## Wireless Rotary Encoder ${{ steps.tag_name.outputs.tag_name }}
          
          ### Installation
          Flash the firmware to your ESP32 using:
          ```bash
          espflash flash wre-esp32-${{ steps.tag_name.outputs.tag_name }}
          ```
          
          ### Setup Instructions
          1. Download the firmware binary
          2. Follow the [QUICKSTART.md](https://github.com/${{ github.repository }}/blob/${{ steps.tag_name.outputs.tag_name }}/QUICKSTART.md) guide
          3. For NodeMCU ESP32, see [NODEMCU_SETUP.md](https://github.com/${{ github.repository }}/blob/${{ steps.tag_name.outputs.tag_name }}/NODEMCU_SETUP.md)
          
          ### Changes
          See the [commit history](https://github.com/${{ github.repository }}/commits/${{ steps.tag_name.outputs.tag_name }}) for details.
        draft: false
        prerelease: false
